<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Document</title>
  <style>
    div {
      display: flex;
    }
  </style>
</head>
<body>
  <div>
    <aside>

    </aside>
    <main>
      <h1 >Lorem, ipsum dolor sit amet consectetur adipisicing elit. A, deserunt!</h1>
      <p>Lorem ipsum dolor sit amet consectetur, adipisicing elit. Sed ea est ex eius temporibus molestias alias explicabo quia, esse eaque similique, beatae, animi iste sint fuga rerum quam voluptates perferendis.</p>
      <p>Culpa, cupiditate dignissimos. Neque deserunt reiciendis quam molestiae vitae tempore, exercitationem aliquid fugit officia similique delectus molestias sed id, facilis nisi dolor mollitia porro. Ipsam quis dolore animi optio consequatur.</p>
      <p>Animi dolor provident tempore expedita amet veritatis. Quisquam sit fugit adipisci, vitae itaque facilis doloremque, ad corporis quasi nemo nam, modi totam similique ex nisi cupiditate quis incidunt harum blanditiis!</p>
      <p>Consequuntur nihil ad blanditiis sint et eius atque ab nesciunt ipsum, numquam eos modi laboriosam quisquam hic tempore quam esse vitae, veniam laudantium neque. Dolore optio quas numquam voluptatem sunt.</p>
      <p>Iure, amet! Explicabo harum iste est architecto ratione dolore dolorem eaque quae tempore nam libero suscipit asperiores sint minus earum nostrum, quos nihil quia facere minima laboriosam deserunt aspernatur nobis.</p>
      <h1>Cumque rem qui aspernatur dolores harum non voluptas aperiam quaerat?</h1>
      <p>Lorem ipsum dolor sit amet consectetur adipisicing elit. Amet unde corrupti reiciendis facilis sint temporibus cum repellat voluptates, suscipit odio numquam inventore? Delectus vitae officia vel nostrum! Possimus, cum ipsa.</p>
      <p>Ducimus vel aspernatur nemo deleniti possimus molestiae deserunt voluptatum, explicabo quas mollitia. Explicabo, asperiores ad reprehenderit magni earum laborum non! Qui quibusdam minus autem? Quo recusandae libero deserunt rerum beatae.</p>
      <p>Ipsa unde ullam tempora quae architecto recusandae sit eos! Ipsum, perferendis vel? Impedit, quibusdam repellendus suscipit cupiditate asperiores aperiam, dolores, eius aliquam laborum labore eligendi voluptatem enim fugiat natus omnis?</p>
      <p>Ullam alias sint tempore dignissimos reiciendis facere quasi nulla eaque, voluptate, non aut incidunt amet aspernatur officia. Alias magnam assumenda, quis dolore, adipisci minus ullam, mollitia necessitatibus sed molestias id.</p>
      <p>Dolorem quisquam accusamus, quam quos tenetur vero impedit? Consequatur minus quisquam nisi suscipit accusantium quos eum, eaque delectus commodi voluptas aut, nihil cumque eveniet iure mollitia ipsa? Cumque, ducimus reprehenderit.</p>
      <h1>Assumenda alias maxime officiis ratione voluptatum iste possimus! Nobis, ipsum!</h1>
      <p>Lorem ipsum dolor sit amet consectetur adipisicing elit. Voluptate nobis ex error architecto impedit consequatur, eveniet, reiciendis ea natus iusto voluptas ab. Maxime in libero, cumque eveniet earum magni perspiciatis.</p>
      <p>Velit architecto nihil dignissimos accusantium nesciunt eius reprehenderit quas itaque ea alias, dolor voluptates ipsum earum, dolores, esse magnam vero quaerat similique eligendi odio quod deleniti fuga sed? Sit, excepturi.</p>
      <p>Porro eum, officia sapiente, molestiae accusantium temporibus obcaecati inventore natus labore odit enim at sit illum ab explicabo sunt aliquam, ratione suscipit esse recusandae hic delectus architecto facere. Magni, eveniet.</p>
      <p>Nobis voluptas impedit, obcaecati qui, architecto atque aliquid laborum odit beatae, facilis illum aliquam possimus aspernatur sit officia! Aperiam quae ex ducimus inventore aspernatur sapiente sint cupiditate animi. Hic, tempora?</p>
      <p>Adipisci, alias consectetur laudantium asperiores provident unde error odit ipsam nobis, debitis eum neque itaque tempora ab dicta? Enim deserunt placeat aliquid nostrum incidunt fugit eos nesciunt aspernatur cupiditate dolorum!</p>
      <h1>Sunt, consequuntur animi. Perferendis alias, numquam dolores minima maiores distinctio.</h1>
      <p>Lorem ipsum dolor sit amet consectetur adipisicing elit. Quis aliquam vel, placeat vitae autem provident modi rem, assumenda temporibus sunt illum dignissimos! Nihil, obcaecati? Distinctio natus minus laudantium qui necessitatibus!</p>
      <p>Voluptas cupiditate non atque numquam molestias quo dolor voluptatem omnis dicta perspiciatis maiores harum sequi iste et eius quidem maxime, obcaecati autem! Praesentium unde, voluptatem recusandae expedita sunt adipisci eos.</p>
      <p>Illo nihil ipsam omnis, porro inventore aliquid corrupti reiciendis aspernatur ipsa facilis hic repellendus rerum velit itaque animi fugit, voluptate soluta! Non modi libero aspernatur, delectus repellendus facilis iste impedit.</p>
      <p>Dicta, ex voluptatum harum minus maxime temporibus reiciendis voluptate consequatur repudiandae quo natus nostrum quasi rem debitis asperiores ipsa sapiente sequi consectetur molestiae aspernatur enim. Consequatur omnis unde nostrum consectetur.</p>
      <p>Dolore ipsa fugiat voluptas fuga sapiente asperiores voluptate cumque aliquam. Animi consequuntur, quis nisi beatae quibusdam voluptatibus molestias sequi dolorem deleniti enim numquam esse sed. Fugit harum beatae obcaecati doloremque!</p>
      <h1>Veritatis ipsam quasi officia totam, architecto laboriosam repellendus cumque magni.</h1>
      <p>Lorem ipsum dolor sit amet consectetur adipisicing elit. Esse ut fugit sapiente a exercitationem debitis maiores sit ea aut dolorum. Ut accusantium veritatis nisi a recusandae ipsam optio, maxime placeat?</p>
      <p>Voluptatibus excepturi neque sint? Non at a facilis vitae ducimus. Modi iusto dolor mollitia culpa et dignissimos aperiam voluptatum iure aliquam ratione, pariatur adipisci optio cumque explicabo at, nemo autem.</p>
      <p>Dolorum quidem laboriosam facilis alias quam soluta sed ratione ex rem magni vero fugiat dolorem ad quo aut, harum provident obcaecati aliquam nam. Aliquam maiores at ut. Tempora, nostrum hic?</p>
      <p>Magni voluptas vitae odio deserunt consequatur molestias. Nemo excepturi quaerat inventore, est commodi modi laboriosam vel natus quibusdam soluta cumque sit illo harum quos, similique ratione voluptate in eveniet error?</p>
      <p>At voluptatum modi voluptate quis esse tenetur voluptates ipsum nam, nostrum rem ratione enim laboriosam dolores quidem voluptatem totam impedit quisquam autem cupiditate quos expedita accusamus. Reiciendis nam modi illo!</p>
      <h1>Et magnam cupiditate possimus dolore accusantium non deserunt vero sint.</h1>
      <p>Lorem ipsum, dolor sit amet consectetur adipisicing elit. Accusamus temporibus nostrum voluptates sed quis libero. Ad, voluptatum possimus? Tempore exercitationem voluptatibus perferendis distinctio corporis et fugiat, delectus aliquam vero aliquid.</p>
      <p>Quod aspernatur soluta qui aperiam maxime necessitatibus eaque. Architecto unde et, consequatur sit assumenda illum nihil beatae ullam omnis sunt nulla. Tempore natus et ex beatae eum, accusamus delectus vero.</p>
      <p>Autem, dolore, nisi officiis sapiente impedit possimus assumenda sed sequi fugit rem deleniti iste. Aperiam ea quod asperiores ipsa molestias. Repellat dignissimos possimus impedit perspiciatis ullam quibusdam corporis deserunt quis.</p>
      <p>Consequuntur, iure minima pariatur explicabo animi perspiciatis sunt odio assumenda ex repudiandae saepe. Voluptates, mollitia vel laboriosam eligendi at id obcaecati explicabo fugiat earum, adipisci vero quasi molestias maiores quaerat.</p>
      <p>Eius dolore qui corporis? Rem eaque dicta nam tempore debitis nostrum labore magnam atque enim numquam reprehenderit optio saepe provident adipisci blanditiis voluptate totam, omnis explicabo ut aliquam ullam veritatis.</p>
      <h1>Dicta minus corrupti repellat inventore quam in. Soluta, suscipit cupiditate.</h1>
      <p>Lorem ipsum dolor sit amet consectetur adipisicing elit. Praesentium dolores, voluptatum quaerat mollitia sunt voluptas saepe molestiae, quae aperiam laborum reiciendis, repudiandae temporibus! Amet nesciunt et voluptatum cupiditate, hic mollitia.</p>
      <p>Fuga, corrupti cupiditate non sapiente explicabo minus culpa iure dolor! Non sint autem harum, vitae voluptate id, minima nesciunt quam officia commodi voluptas nobis eaque magni blanditiis laboriosam maxime quisquam?</p>
      <p>Neque eaque sit iste ipsam voluptatem porro atque cum quos maiores earum, fuga dignissimos aperiam vitae itaque alias optio? Perferendis nulla amet itaque modi quis corporis veniam, inventore maxime impedit?</p>
      <p>Id saepe ipsum quibusdam. Dicta quod minima pariatur quos maxime nesciunt neque vero saepe, accusantium porro deserunt illum earum perspiciatis corporis ducimus assumenda delectus commodi facilis autem ex fugit. Expedita.</p>
      <p>Aliquid quidem ipsam delectus voluptate accusamus illum nostrum numquam perspiciatis molestiae! Voluptates illo eveniet exercitationem veniam doloremque maxime alias, tenetur qui, facere, dolore nam blanditiis quas libero beatae repellat veritatis!</p>
      <h1>Facilis, alias libero? Libero nesciunt natus ex impedit velit quis.</h1>
      <p>Lorem ipsum dolor sit amet consectetur adipisicing elit. Doloribus eum autem quibusdam nesciunt magnam assumenda pariatur unde accusantium ipsa aspernatur obcaecati officiis, laudantium neque qui dolorem esse numquam sit velit!</p>
      <p>Nobis debitis labore exercitationem, earum autem quidem mollitia dignissimos, tempore accusamus officia, facere ipsum animi quam quisquam voluptas! Ducimus, optio obcaecati! Officiis molestiae et excepturi minus. Quae, quisquam repudiandae! Fugit?</p>
      <p>Commodi, praesentium! Nemo nesciunt vero nostrum recusandae. Exercitationem, dolore repellendus dolor recusandae accusantium quisquam cupiditate et! Soluta nisi nihil facere pariatur dignissimos, et molestiae itaque vitae hic distinctio eius omnis.</p>
      <p>Perferendis officiis vel error accusamus nihil asperiores quaerat sint doloribus doloremque quisquam, iure commodi ratione blanditiis, iste quasi, ea tenetur dicta dolorem at corrupti voluptates! Quam porro debitis obcaecati placeat?</p>
      <p>Consequuntur libero, odit perferendis, impedit a eveniet minima fugiat obcaecati voluptatem pariatur blanditiis quas, cum iure quam. Sed exercitationem, dolor non mollitia aspernatur commodi, optio nemo sapiente asperiores maxime blanditiis?</p>
      <h1>Sit dicta rem error quod vero aspernatur veritatis, molestias ducimus?</h1>
      <p>Lorem ipsum dolor sit amet consectetur adipisicing elit. Dolore libero corrupti similique aliquam hic ut, maxime nisi quo totam, cum ea! Expedita ad laudantium corporis, earum maiores ex nemo facere.</p>
      <p>Doloremque perspiciatis similique debitis dolorem! Et molestias hic, iure voluptatibus recusandae velit cumque a. Nulla facere ullam deleniti dicta ratione adipisci quam minus optio, perferendis rerum excepturi non corrupti tempore.</p>
      <p>Facere doloremque quam quos libero itaque laudantium voluptatum, ducimus excepturi, suscipit blanditiis provident corporis. Vitae quo perferendis distinctio culpa maiores. Expedita et unde temporibus consequatur voluptates porro, dolor recusandae ipsa!</p>
      <p>Sit ducimus magnam, quo animi impedit commodi omnis dolorem nisi earum optio corrupti, repellat, laborum dolore obcaecati laudantium facere voluptate debitis? Cumque alias, repellat quasi necessitatibus rerum voluptatibus aliquid pariatur.</p>
      <p>Asperiores dolorem corporis consequuntur iusto praesentium rerum facilis delectus eligendi cum ullam placeat amet, et distinctio similique debitis est adipisci possimus culpa ipsum minus omnis quisquam pariatur. Sapiente, ratione facere!</p>
      <h1>Quibusdam provident suscipit dolorum sint totam ullam alias maxime nemo.</h1>
      <p>Lorem ipsum dolor sit amet consectetur adipisicing elit. Inventore quod quia impedit doloribus recusandae repellat harum molestiae corrupti fugit magni. Cum autem id architecto harum laboriosam culpa sunt tenetur et!</p>
      <p>Doloribus est quo architecto perferendis cum illum ab repellat atque officia minus ea molestiae odit illo quam cumque nobis, excepturi ipsam! Pariatur ea accusantium optio iure repellat obcaecati quisquam illum?</p>
      <p>Architecto suscipit nisi quam omnis aliquam laudantium commodi explicabo animi impedit voluptatibus, incidunt ullam, reprehenderit fugit iure atque ipsa rerum odio minus inventore eveniet provident repellendus. Omnis odit repellat laboriosam?</p>
      <p>Iste excepturi hic laboriosam unde itaque sint perferendis optio nesciunt quidem aut? Sequi quos dolorum, ipsam assumenda, esse quaerat laudantium quisquam error quae, officia ipsa ipsum beatae a veritatis cumque.</p>
      <p>Modi dolorem voluptate repudiandae neque praesentium architecto omnis ipsam sequi optio et autem eaque facere distinctio ex culpa quibusdam quis repellendus, esse minima fugiat repellat, laboriosam mollitia? Laboriosam, dolores magnam!</p>
    </main>
  </div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/tween.js/18.6.4/tween.umd.js"></script>

  <script>
    function scrollSpy(contentNode, tocNode) {
      var headers = Array.from(contentNode.querySelectorAll('h1,h2,h3'))
      var idPrefix = 'id_' + Math.random().toString(16).slice(2)
      var idCount = 0

      for (var header of headers) {
        if (!header.id) {
          header.id = idPrefix + (idCount++)
        }
        var anchor = document.createElement('a')
        anchor.textContent = header.textContent.substr(0, 20)
        anchor.href = '#' + header.id
        anchor.className = 'toc-item'
        tocNode.append(anchor)
      }

      // // 当元素的高度与可滚动内容的高度相同时，说明不能滚动
      // if (contentNode.scrollHeight == contentNode.offsetHeight) {

      // }

      window.addEventListener('scroll', function(e) {
        console.log('scroll')
        var boxes = headers.map(it => it.getBoundingClientRect())
        var curIdx = boxes.findIndex(it => it.y >= 0) // 找到当前正显示的部分的标题的下标
        if (boxes[curIdx].y > window.innerHeight) {
          curIdx--
        }
        var curHeader = headers[curIdx]
        var curId = curHeader.id
        var selector = `.toc-item[href="#${curId}"]`
        var curAnchor = tocNode.querySelector(selector)
        Array.from(tocNode.children).forEach(it => {
          it.classList.remove('active')
        })
        curAnchor.classList.add('active')
      })

      tocNode.addEventListener('xclick', function(e) {
        e.preventDefault()
        var anchor = e.target
        var header = contentNode.querySelector(anchor.getAttribute('href'))
        var targetScrollY = window.scrollY + header.getBoundingClientRect().y
        var currentScrollY = window.scrollY
        var step = (targetScrollY - currentScrollY) / 50
        // var step = targetScrollY >= currentScrollY ? 5 : -5

        console.log('start')
        var obj = {y: currentScrollY}

        new TWEEN.Tween(obj)
          .to({y: targetScrollY}, 700)
          .easing(TWEEN.Easing.Quadratic.InOut)
          .onUpdate(() => {
            console.log(obj.y)
            window.scrollTo(window.scrollX, obj.y)
          })
          .start()

        // requestAnimationFrame(function ani(time) {
        //   currentScrollY += step
        //   window.scrollTo(window.scrollX, currentScrollY)
        //   if (!    (Math.abs(currentScrollY - targetScrollY) < Math.abs(step))     ) {
        //     requestAnimationFrame(ani)
        //   } else {
        //     requestAnimationFrame(function() {
        //       window.scrollTo(window.scrollX, targetScrollY)
        //     })
        //   }
        // })

      })
    }

    // Setup the animation loop.
    function animate(time) {
      requestAnimationFrame(animate)
      TWEEN.update(time)
    }
    requestAnimationFrame(animate)

    var main = document.querySelector('main')
    var aside = document.querySelector('aside')

    scrollSpy(main, aside)
  </script>
  <style>
    aside {
      width: 300px;
      position: fixed;
      top: 0;
      left: 0;
    }
    main {
      margin-left: 300px;
    }
    .toc-item {
      display: block;
    }
    .toc-item.active {
      color: red;
    }
  </style>
</body>
</html>
