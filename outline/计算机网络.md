计算机网络
=========

计算机是人发明的
---------------

# 用上帝视角看网络结构
  * 跟送快递有很多相似的地方

发件人：
收件人：
发件地址：
收件地址：

硬件
function send01(0 or 1,  网口) {}
function sendByte() {}
function sendData() {}
function sendDataTo(data, ip) {
  var 信封 = {
    收件地址： xxxx

  }
  sendData(信封 + data，1号口)
}

function getFile(http://www.xx.com/a.jpg) {

}

网购
服务：快递服务
运输：汽车，火车，飞机
道路：公路，铁路，航空技术
基础架构：基建，科技
材料
物理化学
原子分子

分层结构：

调制 解调 器

# 计算机网络是典型的**分层结构**，也是理解分层模型的极好示例
* 物理层
* 链路层 send(data, address)，在两台直接相连的设备之前收发数据
* 网络层 send(data, ip)，在网络中的任意两台设备间收发数据（点对点的单向传输）
* 传输层 tcp，在两个应用程序间收发数据
  * 会话层
  * 表示层
* 应用层 ，


# 物理层
* 指设备之间的物理连接
  * 可以是有线
    * 网线(橙白，橙，绿白，蓝，蓝白，绿，棕白，棕)
    * 光纤
  * 可以是无线
    * WiFi
    * 3G
    * 4G
* 物理层解决信号的调制与解调
  * 即数字信号与模拟信号之间的转换及传输
* 保证通信的两端能够理解01
* 把上层给到的数据转换为表示01的模拟信号传到电缆上
* 把从电缆接收到的数据转换为01
* 物理层还需要考虑
  * 信号的时钟同步
    * 为此使用了能够同步时钟信号的编码
      * 即曼彻斯特编码（差分曼彻斯特编码）及其变种
  * 电压（流）的大小

速率： 1M bits per second
RTT：  Round Trip Time

数据包在不同协议中的叫法不一样：
链路层：帧 frame
网络层：packet 数据包
TCP： segment  数据段
UDP:  datagram 数据报

# 链路层
* 链路层仅负责直接连接的设备间的通信
  * 实际上真正的网络通信也都是能过局域网一步步传出去的
* 只关心直接连接的机器之间的以字节为单位的通信
* 广播域（多台直接连接的设备组成一个广播域）
* 集线器
* 不同方式下链路层的实现有很多
  * 以太网
    * 载波侦听多路访问
    * 用了交换机以后，基本不存在载波侦听多路访问
  * WiFi
    * 载波侦听多路访问
  * GPRS，3G，4G
* 目前最广泛使用的就是以太网
  * 它的标准拓扑结构为总线型，
    * 总线型
* 在这一层，每个网卡会有一个全球唯一的MAC（Media Access Control Address）地址，用来标示这个设备的ID，虽然只在局域网内使用，但这个ID任然是唯一的
* 局域网之间的通信是通过MAC地址的，而非IP地址
* 计算机会通过ARP协议把IP地址转换为目标机器的MAC地址
  * Address Resolution Protocol
* 交换机就是典型的链路层设备（也称二层设备）
  * 三层交换机.并不是运行在三层,也不做任何三层的事情
  * 只是会识别ip地址等数据包里的三层包头来执行相关的策略
* arp欺骗，广播风暴
* ping 要关掉防火墙


# 网络层（IP层）

* 网络层负责把IP数据包（Packet）从起始机器送达目标机器
  * Best Effort
* 路由器
  * 真正的路由器，而非家用路由器
  * 家用路由器其实是NAT路由
* 瘦腰模型
  * SQL,货币
* NAT网络地址转换
* IP地址的分类
  * A类 子网掩码长度为8
  * B类 子网掩码长度为16
  * C类 子网掩码长度为24
* 特殊IP地址：
  * 127.* 永远指向当前计算机
  * 0.0.0.0 代表当前机器的所有地址，当前机器还没有获取到ip地址时，代表自己的地址（DHCP）
  * 255.255.255.255 广播地址
  * x.y.255.255 特定网域的广播地址
  * 10.* 预留的用于局域网的A类地址
  * 172.xxx 预留的用于局域网的B类地址
  * 192.168.* 预留的用于局域网的C类地址
  * 224-239.*.*.* 多播地址，类似于频道，一般只在局域网中使用

* IP地址，子网掩码与子网的划分
  *
* 不关心是局域网还是广域网
  * 如果是局域网，下层会通过ARP协议把IP转换为MAC地址
* 路由器会根据网络结构选择如何转发分组
  * 各种路由协议
  * 路由表
* DHCP Dynamic Host Configuration Protocal 动态主机配置协议
* VPN一般是在这一层 Virtual Private Network
  * 一般的VPN连接后电脑会多出一个IP地址
  * VPN某种程度上相当于把网线插到了VPN目标所在位置
* tracert / traceroute
* ICMP协议
* IPv6
* 带宽  xxx bps
* 延迟   x
* 域名来源

NAT
  家用路由器
  网络地址转换
    DNAT
    SNAT
  端口转发
  内网可以主动连外网
  外网不能主动连内网
    除非设置了端口转发或DMZ
    对内网形成了一定的保护

# 传输层（TCP/UDP）
* 端口的概念在这一层提出

## UDP
  * 像信箱
  * 非连接型
  * 给定目标位置直接扔过去
  * 无响应，不知道有没有送到
  * 接收方会校验数据的正确性，所以送到的话一般来说是对的

* 代码实现
UDP广播
```js 
sock = dgram.createSocket('udp4')//创建udp套接字
sock.bind(55555)// 绑定端口
sock.addMembership('224.3.3.3') //加入特定频道
sock.addMembership('224.2.2.2') //加入特定频道
sock.setBroadcast(true) // 设置允许发送广播
sock.on('message', (msg, info) => { })//接收消息时的回调函数
sock.address()  //查看当前udp套接字的地址信息
sock.send(msg, port, ip) // 将msg发送到指定目标
```
UDP-广播多播
```js
sock = dgram.createSocket('udp4')

sock.bind(portNumber) // 绑定端口

sock.send(data, port, ip)

sock.setBoardcase(true) // 设置广播发送

sock.addMembership('239.x.x.x') // 加入频道
sock.send(data, 12345, '255.255.255.255') // 发送广播
sock.send(data, 12345, '239.x.x.x') // 发送组播

sock.addEventListener('message', (data, info) => {
  info// 发送者的相关信息，ip，端口，数据长度
})

sock.address() // 获取自己的地址
```

## TCP
  * 通信模型
    * 面向连接
    * 服务端端口
    * 客户端端口
  * 包头
  * 握手
    * 分享初始的接收窗口大小
    * 确认对方可达
  * 保证按顺送达
  * 滑动窗口机制
    * 拥塞窗口，用于拥塞控制
      * 和式增加，积式减少（AIMD）
    * （对方的）接收窗口，用于不要发送过多的数据以至于对方处理不过来
    * 等对方确认收到了窗口前面的字节，再发送后面的数据，同时窗口往后滑动

* 代码实现
```js
var net = require('net')

var server = net.createServer()

server.on('connection', conn => {
  console.log(conn.remoteAddress, conn.remotePort, 'comes in')

  conn.write('将会把发过来的数据转成大写发回去')

  conn.on('data', data => {
    conn.write(data.toString().toUpperCase())
  })

  conn.on('error', () => { })
})

server.listen(55888, () => { // 开始监听
  console.log('监听成功')
})

// server.close() // 停止监听

//  以上是服务器

var conn = net.connect(55888, '10.3.3.3')

// conn.on('data', data => {
//   console.log(data.toString())
// })

conn.read(5)

conn.write('aaaa'.repeat(10000000))
```

# 应用层
* 直接使用TCP或UDP传输自己关心的数据，不关心下层细节（包头，重传，拥塞等）
* DHCP
* DNS
* HTTP

* 如何在系统中查看当前系统打开了多少连接
* 监听了哪个端口
* linux，ss命令
* netstat命令


计算机不能上网了怎么办
重启，重装

两种类型：
  QQ都上不了
    连接目标服务器
  普通网页打不开
    DNS
    连接目标，路由转发
      目标存在
        目标端口是否打开
      目标不存在


加密算法的类型：
  对称加密
    加密和解密用的是同一个密码
  非对称加密
    加密和解密用的是不同密码
    密钥是一对（公钥，私钥）
      用公钥加密需要用私钥解密，反之亦然


http://user:password@domain.com:port/path/to/the/document.html?a=b&c=d#foobar


负载均衡




sudo iptables -t nat -A POSTROUTING -s 192.168.88.0/24 -o eth0 -j MASQUERADE
sudo iptables -t nat -A POSTROUTING -s 10.0.0.0/8 -o wlan0 -j MASQUERADE



查询计算机网络配置信息的命令是什么？
  ipconfig(windows)
  ifconfig(linux), interface config
ping命令做了什么？抓包查验证。
  发送了请求响应的icmp包，收到了响应该请求的icmp包
什么是mac地址？
  Media Access Control 介质访问控制
交换机和集线器有什么区别？
  集线器属于物理层设备，即不能识别链路层的数据包，总是将数据从所有口广播出去
  交换机属性链路层设备，会识别数据包中的mac地址并将数据包从正确的接口送出
交换机的接口有mac地址吗？为什么？
  没有。不是把数据发给交换机的接口，而是通过交换机将数据转发到其它主机。
什么叫网管交换机？
  即三层交换机，能够识别网络层数据包的内容，并做出相应的操作。
    防止ARP欺骗。
  但本质还是只转发链路层数据包。
何为载波帧听多路访问？
  CSMA
  多个设备会同时访问该信道。
  设备发送数据时会同时监听有无收到数据。
为何要使用曼彻斯特编码？
  为了时钟同步，曼彻斯特编码在每个时钟周期都会有信号跳变，可以用来同步
为何要做时钟同步？
  因为不同的设备总会有误差
网络与快递的相似之处体现在什么地方？
  各种地方：
    拓扑结构（主干是网状结构，末端是树状结构）
    转发。数据包在网络中是由各设备转发。包裹在送递过程中也是在不同的网点之间转移
    包格式与快递单很相似。
为什么ip地址是按地区划分的？
  路由器是放在不同地区的，之间有连接
  路由器中的路由表是根据目地ip的前缀来确定数据包的出口的
  所以相同前缀的ip地址会送往相同的方向
    结果就是同一个地区的ip的前缀相同
    类似快递的地址
实验两台电脑直接使用网线连接，设置合适的ip地址后相互ping通。
实验连接在同一交换机的电脑设置不同网络的ip地址是无法相互ping通。
抓包查看并验证tracert的原理。
  依次创建ttl递增的数据包，并接收丢弃的响应。

如何理解VPN？它工作在哪一层？
  相当于机器通过现有网络虚拟出一根网线插到了VPN服务器所在机房
    机器会多出一张虚拟的网卡，网卡还会获得ip地址
  网络层或链路层

IP数据包是如何到达目地址的？
  通过中间路由器的转发

IPv6如何在现行网络上工作？
  IPv6 Over IPv4

DHCP是什么？其协商过程是怎样的？为什么会有租约时间的限制？
  Dynamic Host Configuration Protocal 动态主机配置协议
    DHCP是基于UDP的
  即主机自动获取ip地址配置信息的协议
  广播
  为什么会有租约时间的限制？
    因为设备在拔掉网络直接离开时，已经没有机会通过该网络了

物理层、链路层、网络层分别主要关心的是什么？
  物理层关心01的正确送达与理解
  链路层关心的是直接由电缆连接的多个设备间的通信
  网络层关心网络中任意两台设备间的通信

什么是MTU？典型值是多少？什么情况下其大小不是典型值？
  Max Transport Unit 最大传输单元
  以太网的MTU典型值是1500字节
  连接VPN的时候大小不是典型值

带宽与延迟分别代表什么？说出常见应用更关注带宽还是延迟。
  带宽指每秒传输的数据量/类似于公路的宽度  XXX bps
  延迟(delay) 数据到达目的地的时间/类似于公路的长度  XXX ms
  关注延迟的：游戏，语音，视频
  关注带宽的：直播，下载

DNS服务是什么？其沟通过程是怎样的？为什么不能用域名的方法指定DNS服务器？能否在某台机器上改变一个域名的指向？如何操作？
  域名解析服务，即查询域名的ip地址的服务
  请求，响应
  因为如果用域名指定，这个域名得先被解析出来
  能，修改hosts文件

0.0.0.0与255.255.255.255这两个地址在不同情况代表什么？
  0.0.0.0 可以不知道自己ip地址的时候代表自己的地址
    或在自己的电脑上使用时，代表自己电脑的所有地址
  255.255.255.255 代表广播地址

用手机流量连接教室vpn以实现查看我电脑上的共享文件。
到阿里云申请一个域名并将一个子域名指向某ip地址。

请说出UDP协议的通信模型。
请说出TCP协议的通信模型。
如何可以知道某台机器的某个udp端口是否打开？
  尝试向该端口发送消息，看是否能够收到回复
  如果能收到回复，则说明它一定是打开的
  否则什么也不能说明

如何查看当前系统中打开的TCP连接？
如何查看当前系统中正在侦听的TCP服务端口及UDP端口？
  windows： 资源监视器
  linux/mac： ss 查看连接   ss -l 查看侦听端口
  
TCP头部的序列号和确认号分别代表什么？
  序列号：代表发送方发送的这个数据包中第一个字节的总编号
  确认号：代表接收方已经收到了这个号码之前的字节，或是这个字节所在的数据包是没收到的

为什么建立TCP连接需要三次握手？断开时需要四次挥手？
  三次握手：一次有效的信息交换本来就需要至少三次成功的单向通信。
           三次才能让双方确认自己发的对方能收到，对方发的自己能收到。
  四次挥手： 不一定是四次，也可能是三次
        可能为四次的原因为tcp可以处于半开状态，即一方不再发只收，另一方不收只发。


TCP协议关注的重点是什么？
  数据
  数据管道
  程序到程序间的双向按序送达

为什么红蜘蛛软件人多也不卡？但有可能花屏？
  因为红蜘蛛用的是udp广播，数据只会发送固定的次数，有可能产生丢包
  而广播不随人数的变化而降低效率
为什么另一个投屏软件人多就会卡？
  因为它用的是tcp，只能单播
  不仅会卡：是因为人多让网络拥塞
  还会延迟：因为可能存在队头阻塞
有一个协议叫NTP，意为网络时间协议，用来对系统进行对时，不查网络，请问你觉得它基于什么协议？
  它基于UDP
    数据包小，且更在意延迟的长短，用tcp根本就无法知道数据包在背后被重传了多少次
为什么DNS协议不基于TCP而要基于UDP？
  dns请求所需的数据足够小，小到一个udp包就可以完全容纳
为什么另一些协议需要基于TCP？
  因为它们可能要发送大量的数据，并且保证数据的正确性
什么情况更适合tcp，什么情况更适合udp？
  更适合tcp：数据量大且需要保证按序送达时，或需要多次对话的应用
    数据量大但不需要按序送达也可以用udp，如红蜘蛛
  更适合udp：数据量可以在一个udp包里放下，或者一个小数据包的来回就成了全部的对话过程，或者保证实时性
        如dns， dhcp，，ntp



TCP端口的监听状态是什么意思？
  指服务器程序在某端口等待其它客户端连接
TCP基于连接是什么意思？
  通信之前要先建立连接，连接成功后双方仅可以在这个连接上相互收发信息
TCP的协议模型是什么？
  服务器在某端口监听，多个客户端可以同时连接到这个服务器端口
TCP协议如何保证数据的按序送达？
  为数据编号
TCP与UDP有什么区别？为什么需要TCP？
  tcp基于连接的，而udp不是
  tcp要先建立连接，udp不用
  tcp能保证数据按序送达，udp不能
  tcp以字节流的方式通信，udp以消息/数据包的方式通信
  udp可以在局域网广播，tcp不能
  为什么需要TCP？
    当需要数据被保证按序送达时，需要tcp，即使不使用tcp，最终也会自己实现一个拙劣的tcp
为什么DNS，DHCP等协议是基于UDP而不是基于TCP的？
  DNS，DHCP等协议的数据在一个UDP包中就可以完全表达
    DHCP基于UDP还因为其需要广播

为什么TCP服务端可以用同一个端口与无数其它机器建立TCP连接？
  因为发送到该端口的数据包会按来源ip与来源端口进行分组，相同的来源ip与端口的数据包会被分在一个组里，当成同一个连接的数据

如何探测某主机的一个端口是否处于TCP服务监听状态？
  尝试连接
  net.connect(553, '127.0.0.1')
  nc  115.35.244.22  5544
  telnet     ip   port

TCP协议有哪些状态？状态之间是如何迁移的？
如何查看电脑上有哪些程序正在监听哪些TCP端口？
  window： 资源监视器
  linux： ss -l命令

为什么Inletex Easy Meeting Classic软件画面从来不会花但是人多时会比较卡？
  该软件使用tcp进行画面的传输。
  tcp是不支持广播的，所以人越多，网络负担就越大，也就越卡

红蜘蛛为什么会花屏？但为什么不卡？
  红蜘蛛使用的是局域网udp广播或多播，数据包在每根网线上只走了一次，跟人数无关
  但udp不能保证数据送达，所以会花屏

为什么TCP建立链接需要3次握手？所谓的握手是什么意思？
  根本原因是双方进行一次有效的信息交换至少需要3次单向沟通
  握手指的是发送了三个数据锯
为什么TCP断开连接需要4次挥手？
  也可能是三次。
  因为tcp连接支持半开，即一方不发送数据了，但还可以接收数据
TCP协议的滑动窗口是什么？

TCP的序列号是什么？其代表什么？
  表示本数据包中数据的第一个字节是发过的第几个字节
确认号是什么？其代表什么？
  已经收到这个字节前的所有字节
序列号与确认号为什么是随机的？
  为了防止被伪造的数据撞进接收窗口里
什么是TCP四元组？
  由  （源ip，源端口，目的ip，目的端口）  这四个信息组成的整个信息


抓包查看TCP连接的握手，数据传输，ACK及挥手的的数据包。
在自己电脑上建立TCP服务端口并让多于两个客户端连接进来以理解TCP的协议模型。
什么是域名的A记录，CNAME，MX记录？域名查询命令是什么？
  NSLOOKUP
  DIG
  PING
如何查看UDP端口是否绑定成功？有什么命令？
  资源监视器/端口侦听
    对于tcp，侦听指等待连接
    对于udp，侦听指等待数据
  SS -UL
hosts文件是什么？有什么作用与应用？
  用来在本地上让一些域名指向设定的ip的

DNS服务是用来干嘛的？其服务端口是多少？
  53
DHCP服务端口为67
NTP服务端口为123


网络安全：
  通信安全
    通信的对方是不是想要通信的对方
    通信的内容不被中间设备截获和篡改

常见网络攻击手段：

局域网：
  ping攻击（网管交换机限制流量）
  ARP欺骗（网管交换机）
  广播风暴（禁止广播）

广域网：
  伪造IP数据包。
  TCP SYN Flood
  TCP DoS Deny of Service Attack
  NTP 时间服务器攻击


计算机不能上网的一般解决方案

ping www.baidu.com

ping 114.114.114.114

ping 10.0.0.1

nc  xxx  80

ss -l  -n

什么是NAT？它的目的是？
  Net Address Transform 网络地址转换
  目的是让多个设备共用一个公网ip地址
  通过nat路由发出的数据包，会将源地址改为路由自己的公网ip地址
  通过nat路由收到的数据包，会将目地址改为路由自己的内网某台设备的内网地址
  整个过程对内网的设备是透明的

NAT会产生什么副作用？
  内网的设备在侦听状态的话，也无法接收来自外网的连接请求
  nat路由让内网电脑非公网暴露状态，将免于很多可能的网络攻击

如何知道自己的电脑是否处于NAT网络中？
  查看自己所在网络的公网ip地址是否跟自己的ip地址相同，如果是，则不在nat网络中
  通过ip138.com等网站

如果是，如何知道自己所在网络的公网IP地址？原理是？
  通过ip138.com等网站
  它们通过头部读取到你的公网ip，并将其放入回复的数据包内部

什么是DMZ？作用是？
  通过nat路由的设置，将内网的一台设备暴露于公网
  即路由器收到的不知道该转发给内网哪台设备的数据包，都将转发给设置的dmz主机

如何知道一台机器的某个端口是否有TCP Server正在侦听？
  尝试连一下
    nc ip port
    net.connect(port, ip)
  也可以给服务器的主人打电话询问

TCP连接时出现的CONNECTION_REFUSED和CONNECTION_TIME_OUT以及CONNECTION_RESET报错分别代表什么意思？ 
  CONNECTION_REFUSED
    远程机器拒绝了连接，往往因为它没有在侦听该端口
  CONNECTION_TIME_OUT
    连接超时，即远程机器在限制的时间内未回复
  CONNECTION_RESET
    连接被重置
      往往是因为连接出现了不可恢复的错误
      通过tcp头部的reset标记为1来重置。

什么是TCP协议的粘包？上层应该如何处理这种情况？
  发送方发送多次，接收方可能只通过一次函数调用（或事件）就收到了这多次发来的数据
  上层需要自行识别数据中的区段

FTP为何基于TCP而不是UDP？
  ftp要传输大量数据和指令，传指令的时候需要指令按序到达

FTP中传输数据时为什么要新开一个TCP连接？
  如果数据太大，那么传输数据时，就无法发送指令了，因为根据tcp的特性，前面的数据不消费完，后面的数据是不会被消费的
非对称加密的特点是什么？它能实现哪些看似难以完成的任务？
  加密与解密使用的是不同的密码，称为公钥和私钥，公钥加密需要私钥解密，私钥需要公钥解密
  可以实现电子签名
    通过用私钥加密实现，只能拿对应的公钥解密，则证明该信息只能是持有对应私钥的人发出
  可以实现防窃听
websocket协议的模型是？它解决的主要问题是什么？
  将tcp协议抽象成了以消息为单位的，而非以数据流为单位，无需上层应用自行识别消息段
  它解决的主要问题是什么？为tcp上传输数据增加了“隔板”
证书中包含什么信息？为什么它不可伪造？并且其它人拿了也没用？
  证书中包含证书的所有者，签发者（CA），证书的目的（要证明的事情）
    还有以上内容的哈希签名（即将以上内容的哈希使用签发者私钥加密/签名）
  没有签发者的私钥，当然不可伪造
  并且其它人拿了也没用？因为证书证明的不是别人，是所有者
